<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Anak Hebat (Lokal)</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Ikon dari Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; 
            padding-bottom: 72px; 
        }
        /* Style untuk tombol yang sudah selesai (checked) */
        .card-selesai {
            background-color: #dcfce7 !important; 
            border-color: #22c55e !important;
            opacity: 0.9;
            cursor: pointer;
        }
        .card-selesai .ikon-centang { display: block !important; }
        .card-selesai .teks-poin { display: none !important; }

        .misi-card {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #e5e7eb;
            cursor: pointer;
        }
        .misi-card:hover:not(.card-selesai) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .ikon-misi {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-right: 1rem;
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 50;
        }
        .nav-bar button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            color: #9ca3af;
            transition: color 0.2s;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .nav-bar button i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .nav-bar button.active {
            color: #3b82f6; 
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-md mx-auto p-4 relative">
        <!-- Header Aplikasi -->
        <header class="mb-6 pt-2">
            <h1 id="header-salam" class="text-2xl font-extrabold text-gray-800 mb-1">Hai, Budi! üëã</h1>
            <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-lg border-b-4 border-yellow-500">
                <span class="text-sm font-semibold text-gray-600">Total Bintang Anda:</span>
                <span class="text-3xl font-extrabold text-yellow-600 flex items-center">
                    <i class="ph-fill ph-star mr-1"></i>
                    <span id="total-bintang">0</span>
                </span>
            </div>
            
            <!-- Progress Bar (Hanya ditampilkan di halaman Misi) -->
            <div id="progress-container" class="mt-4">
                <p id="progres-teks" class="text-sm font-medium text-gray-700 mb-1">0/7 Misi</p>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progres-bar" class="h-3 rounded-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- Halaman Misi Harian -->
        <div id="page-misi" class="page space-y-3">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Misi Harian Anda:</h2>
            
            <!-- Container untuk Misi Harian (Akan diisi oleh JavaScript) -->
            <div id="misi-list-container" class="space-y-3">
                <!-- Misi cards will be rendered here dynamically -->
            </div>
            
            <!-- Tombol Reset Misi Harian -->
            <button id="reset-button" class="w-full mt-6 py-3 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition-colors">
                <i class="ph-fill ph-arrow-clockwise mr-2"></i> Mulai Hari Baru
            </button>
        </div>

        <!-- Halaman Toko Hadiah -->
        <div id="page-toko" class="page hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Toko Virtual (Aksesoris & Latar Belakang)</h2>
            <div id="shop-items-container" class="grid grid-cols-2 gap-4 mb-8">
                <!-- Item 1: Aksesori Bintang -->
                <div id="item-1" data-cost="50" class="flex flex-col items-center bg-white p-4 rounded-xl shadow-lg border-2 border-yellow-300">
                    <span class="text-4xl mb-2">‚≠ê</span>
                    <p class="font-semibold text-center mb-1">Stiker Bintang Biru</p>
                    <p class="text-xs text-gray-500 mb-3">Aksesori</p>
                    <button class="btn-beli w-full py-2 bg-yellow-400 text-white font-bold rounded-lg hover:bg-yellow-500 transition-colors" data-item="item-1">
                        50 <i class="ph-fill ph-star text-sm"></i>
                    </button>
                </div>
                <!-- Item 2: Latar Belakang Galaksi -->
                <div id="item-2" data-cost="150" class="flex flex-col items-center bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-300">
                    <span class="text-4xl mb-2">üåå</span>
                    <p class="font-semibold text-center mb-1">Latar Belakang Galaksi</p>
                    <p class="text-xs text-gray-500 mb-3">Latar Belakang</p>
                    <button class="btn-beli w-full py-2 bg-yellow-400 text-white font-bold rounded-lg hover:bg-yellow-500 transition-colors" data-item="item-2">
                        150 <i class="ph-fill ph-star text-sm"></i>
                    </button>
                </div>
                <!-- Item 3: Topi Penyihir -->
                <div id="item-3" data-cost="200" class="flex flex-col items-center bg-white p-4 rounded-xl shadow-lg border-2 border-purple-300">
                    <span class="text-4xl mb-2">üßô</span>
                    <p class="font-semibold text-center mb-1">Topi Penyihir</p>
                    <p class="text-xs text-gray-500 mb-3">Aksesori</p>
                    <button class="btn-beli w-full py-2 bg-yellow-400 text-white font-bold rounded-lg hover:bg-yellow-500 transition-colors" data-item="item-3">
                        200 <i class="ph-fill ph-star text-sm"></i>
                    </button>
                </div>
                <!-- Item 4: Latar Belakang Hijau Daun -->
                <div id="item-4" data-cost="300" class="flex flex-col items-center bg-white p-4 rounded-xl shadow-lg border-2 border-green-300">
                    <span class="text-4xl mb-2">üåø</span>
                    <p class="font-semibold text-center mb-1">Latar Hijau Daun</p>
                    <p class="text-xs text-gray-500 mb-3">Latar Belakang</p>
                    <button class="btn-beli w-full py-2 bg-yellow-400 text-white font-bold rounded-lg hover:bg-yellow-500 transition-colors" data-item="item-4">
                        300 <i class="ph-fill ph-star text-sm"></i>
                    </button>
                </div>
            </div>

            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Tukar Hadiah Fisik</h2>
            <div id="physical-reward-list" class="space-y-3">
                <!-- Rewards akan dirender di sini oleh JavaScript -->
            </div>
        </div>

        <!-- Halaman Profil & Inventori -->
        <div id="page-profil" class="page hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Profil Anak</h2>

            <!-- Avatar dan Info -->
            <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center mb-6">
                <div class="relative avatar-container w-28 h-28 flex items-center justify-center rounded-full border-4 border-orange-500 bg-yellow-200 transition-all duration-300">
                    <span class="avatar-body text-6xl">üßë</span>
                    <span class="avatar-overlay absolute text-4xl top-0 right-0"></span>
                </div>
                <div class="mt-4 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <h3 id="nama-anak-profil" class="text-2xl font-extrabold text-gray-800">Budi</h3>
                        <button id="btn-edit-nama" class="text-blue-500 hover:text-blue-600"><i class="ph-light ph-pencil-simple text-xl"></i></button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Total Bintang: <span id="total-bintang-profil" class="font-bold text-yellow-600">0</span></p>
                </div>
            </div>

            <!-- Inventori -->
            <h3 class="text-lg font-bold text-gray-700 mb-3">Inventori (Ketuk untuk Menggunakan)</h3>
            <div id="inventory-list" class="grid grid-cols-3 gap-4">
                <!-- Item inventori akan di-render di sini -->
            </div>
            <p id="empty-inventory-message" class="text-sm text-center text-gray-500 mt-4 hidden">Inventori masih kosong. Yuk, belanja!</p>

            <button data-page="ortu" class="w-full mt-6 py-3 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition-colors">
                <i class="ph-fill ph-lock-key-open mr-2"></i> Masuk Dashboard Orang Tua
            </button>
        </div>
        
        <!-- Halaman Dashboard Orang Tua -->
        <div id="page-ortu" class="page hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Dashboard Orang Tua</h2>

            <!-- PIN Lock Screen -->
            <div id="ortu-pin-lock" class="flex flex-col items-center justify-center h-64 bg-white rounded-xl shadow-lg p-6">
                <i class="ph-fill ph-lock text-5xl text-red-500 mb-4"></i>
                <p class="text-lg font-semibold mb-3">Masukkan PIN Orang Tua</p>
                <form id="pin-form" class="w-full max-w-xs">
                    <input type="password" id="pin-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-center text-xl tracking-widest focus:ring-2 focus:ring-blue-500 focus:border-blue-500" maxlength="4" required>
                    <p id="pin-message" class="text-xs mt-2 h-4"></p>
                    <button type="submit" class="w-full mt-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors">Masuk</button>
                </form>
            </div>

            <!-- Parent Dashboard (Visible after PIN) -->
            <div id="ortu-dashboard" class="hidden space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl shadow-md">
                    <p class="text-sm font-semibold text-blue-800">Ringkasan untuk: <span id="ortu-nama-anak" class="font-extrabold">Budi</span></p>
                    <p class="text-sm text-gray-600">Total Bintang Anak: <span class="font-bold text-yellow-600" id="ortu-total-bintang-display"></span></p>
                </div>
                
                <h3 class="text-lg font-bold text-gray-700 mb-3 pt-2">Pengaturan Hadiah & Misi</h3>

                <button id="atur-hadiah-btn" class="w-full py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-md hover:bg-indigo-600 transition-colors">
                    <i class="ph-fill ph-gift mr-2"></i> Atur Hadiah Fisik
                </button>
                
                <button id="edit-misi-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition-colors">
                    <i class="ph-fill ph-list-checks mr-2"></i> Edit Misi Harian
                </button>

                <button id="logout-button" class="w-full mt-6 py-2 bg-red-400 text-white font-semibold rounded-lg hover:bg-red-500 transition-colors">
                    <i class="ph-fill ph-sign-out mr-2"></i> Keluar Dashboard
                </button>
            </div>
        </div>
    </div>
    
    <!-- Kontainer Navigasi Bawah -->
    <div class="nav-bar">
        <button data-page="misi" class="active">
            <i class="ph-fill ph-clipboard-text"></i>
            <span>Misi</span>
        </button>
        <button data-page="toko">
            <i class="ph-light ph-storefront"></i>
            <span>Toko</span>
        </button>
        <button data-page="profil">
            <i class="ph-light ph-user-circle"></i>
            <span>Profil</span>
        </button>
        <button data-page="ortu">
            <i class="ph-light ph-lock-key"></i>
            <span>Ortu</span>
        </button>
    </div>

    <!-- Modal 1: Edit Nama -->
    <div id="modal-edit-nama" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Nama Anak</h3>
            <input type="text" id="input-nama-baru" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama baru">
            <div class="flex justify-end space-x-3">
                <button id="tutup-nama-btn" class="px-4 py-2 text-gray-500 font-semibold rounded-lg hover:text-red-500">Batal</button>
                <button id="simpan-nama-btn" class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Atur Hadiah Fisik -->
    <div id="modal-hadiah-fisik" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-600 mb-4 text-center">Atur Hadiah Fisik</h3>
            
            <h4 class="font-semibold text-gray-700 mb-2">Daftar Hadiah:</h4>
            <div id="edit-hadiah-container" class="space-y-2 max-h-48 overflow-y-auto p-2 border rounded-lg bg-gray-50 mb-4">
                <!-- Hadiah akan di-render di sini -->
            </div>

            <h4 class="font-semibold text-gray-700 mb-2">Tambah Hadiah Baru:</h4>
            <form id="form-tambah-hadiah" class="space-y-2">
                <input type="text" id="input-hadiah-nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Hadiah (cth: Pergi ke kebun binatang)" required>
                <input type="number" id="input-hadiah-poin" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Poin yang dibutuhkan (cth: 500)" min="10" required>
                <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition-colors">Tambah Hadiah</button>
            </form>
            
            <button id="tutup-hadiah-btn" class="w-full mt-4 py-2 text-gray-500 font-semibold rounded-lg hover:text-red-500">Selesai</button>
        </div>
    </div>
    
    <!-- Modal 3: Unggah Bukti Misi -->
    <div id="modal-unggah-bukti" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-600 mb-4 text-center">Unggah Bukti Misi</h3>
            <p id="bukti-misi-nama" class="text-lg font-semibold text-gray-800 mb-3 text-center"></p>

            <form id="form-unggah-bukti" class="space-y-4">
                <div class="border-2 border-dashed border-blue-300 rounded-xl p-6 text-center hover:border-blue-500 transition-colors">
                    <!-- Elemen input file yang disembunyikan untuk tampilan yang lebih rapi -->
                    <input type="file" id="input-bukti-file" class="hidden" accept="image/*,video/*">
                    <label for="input-bukti-file" id="label-bukti-file" class="block cursor-pointer">
                        <i class="ph-light ph-image text-4xl text-blue-500 mx-auto block mb-2"></i>
                        <p class="text-sm font-medium text-blue-600">Pilih Foto atau Video</p>
                        <p class="text-xs text-gray-500 mt-1">Maks. 5MB (Simulasi)</p>
                        <p id="file-name-display" class="text-xs font-semibold text-gray-700 mt-2">Belum ada file dipilih</p>
                        <p class="text-xs text-red-500 mt-1" id="file-error-message" style="display: none;">Ukuran file terlalu besar! (Maks 5MB)</p>
                    </label>
                </div>
                
                <input type="hidden" id="misi-id-terpilih">
                
                <button type="submit" id="btn-submit-bukti" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl transition-colors hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Selesaikan Misi (Kirim Bukti)
                </button>
                
                <button type="button" id="tutup-bukti-btn" class="w-full text-gray-500 font-semibold py-1 rounded-xl hover:text-red-500 transition-colors">
                    Batal
                </button>
            </form>
        </div>
    </div>

    <!-- Modal 4: Edit Misi -->
    <div id="modal-edit-misi" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-green-600 mb-4 text-center">Edit Misi Harian</h3>
            <p class="text-sm text-gray-500 mb-3">Atur nama dan poin untuk setiap misi. Misi baru akan menggunakan ikon default (üìö).</p>
            
            <h4 class="font-semibold text-gray-700 mb-2">Daftar Misi Aktif:</h4>
            <div id="edit-misi-container" class="space-y-2 max-h-48 overflow-y-auto p-2 border rounded-lg bg-gray-50 mb-4">
                <!-- Misi akan di-render di sini oleh JS -->
            </div>

            <h4 class="font-semibold text-gray-700 mt-4 mb-2 border-t pt-4">Tambah Misi Baru:</h4>
            <form id="form-tambah-misi" class="space-y-2">
                <input type="text" id="input-misi-nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Misi Baru (cth: Merapikan mainan)" required>
                <input type="text" id="input-misi-keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Keterangan (cth: Taruh di kotak setelah bermain)" required>
                <input type="number" id="input-misi-poin" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Poin yang didapat (cth: 20)" min="1" required>
                <button type="submit" class="w-full py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="ph-fill ph-plus mr-2"></i> Tambah Misi
                </button>
            </form>

            <button id="tutup-misi-btn" class="w-full mt-4 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">
                <i class="ph-fill ph-floppy-disk mr-2"></i> Simpan & Selesai
            </button>
        </div>
    </div>


    <script>
        // --- INI ADALAH VERSI LOKAL (OFFLINE) MENGGUNAKAN localStorage ---
        // VERSI INI TIDAK MEMBUTUHKAN FIREBASE DAN PASTI AKAN BERHASIL DI GITHUB PAGES.
        
        let totalBintang = parseInt(localStorage.getItem('totalBintang')) || 0;
        let namaAnak = localStorage.getItem('namaAnak') || 'Anak Hebat';
        let inventory = JSON.parse(localStorage.getItem('inventory')) || {};
        let isParentAuthenticated = false;
        const parentPin = '1234'; 

        const defaultMissions = {
            'misi-1': { id: 'misi-1', nama: 'Bangun Pagi', keterangan: 'Bangun sebelum jam 06:00', poin: 10, completed: false, ikonClass: 'ph-fill ph-sun', ikonBg: 'bg-yellow-100 text-yellow-600'},
            'misi-2': { id: 'misi-2', nama: 'Beribadah', keterangan: 'Berdoa atau sholat tepat waktu', poin: 15, completed: false, ikonClass: 'ph-fill ph-hands-praying', ikonBg: 'bg-sky-100 text-sky-600'},
            'misi-3': { id: 'misi-3', nama: 'Berolahraga', keterangan: 'Gerak badan minimal 15 menit', poin: 10, completed: false, ikonClass: 'ph-fill ph-basketball', ikonBg: 'bg-orange-100 text-orange-600'},
            'misi-4': { id: 'misi-4', nama: 'Makan Sehat', keterangan: 'Makan sayur dan buah', poin: 10, completed: false, ikonClass: 'ph-fill ph-carrot', ikonBg: 'bg-green-100 text-green-600'},
            'misi-5': { id: 'misi-5', nama: 'Gemar Belajar', keterangan: 'Membaca buku atau belajar 30 menit', poin: 15, completed: false, ikonClass: 'ph-fill ph-book-open', ikonBg: 'bg-indigo-100 text-indigo-600'},
            'misi-6': { id: 'misi-6', nama: 'Bermasyarakat', keterangan: 'Membantu orang tua di rumah', poin: 10, completed: false, ikonClass: 'ph-fill ph-heart', ikonBg: 'bg-pink-100 text-pink-600'},
            'misi-7': { id: 'misi-7', nama: 'Tidur Cepat', keterangan: 'Tidur sebelum jam 21:00', poin: 10, completed: false, ikonClass: 'ph-fill ph-moon', ikonBg: 'bg-purple-100 text-purple-600'}
        };
        let currentMissions = JSON.parse(localStorage.getItem('currentMissions')) || defaultMissions;
        let totalMisi = Object.keys(currentMissions).length; 

        const shopItems = {
            'item-1': { cost: 50, type: 'aksesoris', value: '‚≠ê', nama: 'Stiker Bintang Biru' },
            'item-2': { cost: 150, type: 'latar', value: '#1e3a8a', nama: 'Latar Belakang Galaksi' },
            'item-3': { cost: 200, type: 'aksesoris', value: 'üßô', nama: 'Topi Penyihir' },
            'item-4': { cost: 300, type: 'latar', value: '#d9f99d', nama: 'Latar Hijau Daun' }
        };

        let physicalRewards = JSON.parse(localStorage.getItem('physicalRewards')) || [
            { id: 'reward-1', name: 'Es Krim Favorit', cost: 100, used: false },
            { id: 'reward-2', name: 'Bermain Game Tambahan 30 Menit', cost: 200, used: false }
        ];

        // --- DOM ELEMENTS ---
        const totalBintangEl = document.getElementById('total-bintang');
        const headerSalamEl = document.getElementById('header-salam');
        const progresBarEl = document.getElementById('progres-bar');
        const progresTeksEl = document.getElementById('progres-teks');
        const misiContainerEl = document.getElementById('page-misi');
        const misiListContainerEl = document.getElementById('misi-list-container'); 
        const resetBtnEl = document.getElementById('reset-button');
        const avatarContainerEl = document.querySelector('.avatar-container');
        const avatarBodyEl = document.querySelector('.avatar-body');
        const avatarOverlayEl = document.querySelector('.avatar-overlay');
        const navButtons = document.querySelectorAll('.nav-bar button');
        const progressContainerEl = document.getElementById('progress-container');
        
        const namaAnakEl = document.getElementById('nama-anak-profil');
        const totalBintangProfilEl = document.getElementById('total-bintang-profil');
        const btnEditNamaEl = document.getElementById('btn-edit-nama');
        const inventoryListEl = document.getElementById('inventory-list');
        const emptyInventoryMessageEl = document.getElementById('empty-inventory-message');
        const physicalRewardListEl = document.getElementById('physical-reward-list');
        
        const ortuPinLockEl = document.getElementById('ortu-pin-lock');
        const ortuDashboardEl = document.getElementById('ortu-dashboard');
        const pinInputEl = document.getElementById('pin-input');
        const pinMessageEl = document.getElementById('pin-message');
        const pinFormEl = document.getElementById('pin-form');
        const logoutButtonEl = document.getElementById('logout-button');
        const aturHadiahBtn = document.getElementById('atur-hadiah-btn');
        const editMisiBtn = document.getElementById('edit-misi-btn');
        const ortuNamaAnakEl = document.getElementById('ortu-nama-anak');
        const ortuTotalBintangDisplayEl = document.getElementById('ortu-total-bintang-display');


        const modalEditNamaEl = document.getElementById('modal-edit-nama');
        const inputNamaBaruEl = document.getElementById('input-nama-baru');
        const tutupNamaBtn = document.getElementById('tutup-nama-btn');
        const simpanNamaBtn = document.getElementById('simpan-nama-btn');
        const modalHadiahFisikEl = document.getElementById('modal-hadiah-fisik');
        const editHadiahContainerEl = document.getElementById('edit-hadiah-container');
        const formTambahHadiahEl = document.getElementById('form-tambah-hadiah');
        const inputHadiahNamaEl = document.getElementById('input-hadiah-nama');
        const inputHadiahPoinEl = document.getElementById('input-hadiah-poin');
        const modalEditMisiEl = document.getElementById('modal-edit-misi');
        const tutupMisiBtn = document.getElementById('tutup-misi-btn');
        const editMisiContainerEl = document.getElementById('edit-misi-container');
        const tutupHadiahBtn = document.getElementById('tutup-hadiah-btn');
        
        const formTambahMisiEl = document.getElementById('form-tambah-misi');
        const inputMisiNamaEl = document.getElementById('input-misi-nama');
        const inputMisiKeteranganEl = document.getElementById('input-misi-keterangan');
        const inputMisiPoinEl = document.getElementById('input-misi-poin');


        const modalUnggahBuktiEl = document.getElementById('modal-unggah-bukti');
        const tutupBuktiBtn = document.getElementById('tutup-bukti-btn');
        const formUnggahBuktiEl = document.getElementById('form-unggah-bukti');
        const inputBuktiFileEl = document.getElementById('input-bukti-file');
        const fileNameDisplayEl = document.getElementById('file-name-display');
        const btnSubmitBuktiEl = document.getElementById('btn-submit-bukti');
        const misiIdTerpilihEl = document.getElementById('misi-id-terpilih');
        const buktiMisiNamaEl = document.getElementById('bukti-misi-nama');
        const fileErrorMessageEl = document.getElementById('file-error-message');


        const pages = {
            'misi': document.getElementById('page-misi'),
            'toko': document.getElementById('page-toko'),
            'profil': document.getElementById('page-profil'),
            'ortu': document.getElementById('page-ortu')
        };
        const pesanSelesai = document.createElement('div');
        pesanSelesai.className = 'p-4 text-center font-bold text-green-600 bg-green-50 rounded-xl shadow-inner my-3';
        pesanSelesai.textContent = 'Hebat! Semua misi hari ini selesai. Istirahat dulu ya! ‚ú®';

        // --- UTILITY FUNCTIONS ---
        function saveState() {
            localStorage.setItem('totalBintang', totalBintang);
            localStorage.setItem('namaAnak', namaAnak);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            // Menyimpan objek misi (bukan array)
            localStorage.setItem('currentMissions', JSON.stringify(currentMissions));
            localStorage.setItem('physicalRewards', JSON.stringify(physicalRewards));
        }

        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
        }

        function hideModal(modalElement) {
            modalElement.classList.add('hidden');
        }
        
        function renderMisiCards() {
            misiListContainerEl.innerHTML = '';
            
            let misiSelesai = 0;
            totalMisi = Object.keys(currentMissions).length;

            Object.values(currentMissions).forEach(misi => {
                const card = document.createElement('div');
                card.id = misi.id;
                card.className = `misi-card ${misi.completed ? 'card-selesai' : ''}`;
                card.setAttribute('data-nama', misi.nama);

                const defaultIkonClass = 'ph-fill ph-book'; 
                const defaultIkonBg = 'bg-gray-100 text-gray-600'; 

                const ikonClass = misi.ikonClass || defaultIkonClass;
                const ikonBg = misi.ikonBg || defaultIkonBg;

                card.innerHTML = `
                    <div class="ikon-misi ${ikonBg}"><i class="${ikonClass}"></i></div>
                    <div class="info-misi flex-grow">
                        <h3 class="font-semibold text-gray-800">${misi.nama}</h3>
                        <p class="text-xs text-gray-500">${misi.keterangan}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="teks-poin text-base font-bold text-yellow-500" style="${misi.completed ? 'display: none;' : ''}">+${misi.poin}</span>
                        <i class="ikon-centang ph-fill ph-check-circle text-2xl text-green-500" style="${misi.completed ? 'display: block;' : 'display: none;'}"></i>
                    </div>
                `;
                misiListContainerEl.appendChild(card);
                
                if (misi.completed) {
                    misiSelesai++;
                }

                card.addEventListener('click', handleMisiCardClick);
            });
            
            progresTeksEl.textContent = `${misiSelesai}/${totalMisi} Misi`;
            const persentase = (misiSelesai / totalMisi) * 100;
            progresBarEl.style.width = `${persentase}%`;
            
            if (misiSelesai === totalMisi && totalMisi > 0) {
                if (!misiContainerEl.contains(pesanSelesai)) {
                    misiContainerEl.insertBefore(pesanSelesai, resetBtnEl); 
                }
            } else {
                if (misiContainerEl.contains(pesanSelesai)) {
                    pesanSelesai.remove();
                }
            }
        }
        
        function updateTampilan() {
            totalBintangEl.textContent = totalBintang;
            ortuTotalBintangDisplayEl.textContent = totalBintang;
            
            headerSalamEl.textContent = `Hai, ${namaAnak}! üëã`;
            
            namaAnakEl.textContent = namaAnak;
            totalBintangProfilEl.textContent = totalBintang;
            ortuNamaAnakEl.textContent = namaAnak;

            renderMisiCards(); 
            renderHadiahFisikList();
            renderEditHadiahList();
            renderInventory();
            applyAvatarStyle();
            updateShopButtons(); 
            saveState();
        }

        function updateShopButtons() {
            document.querySelectorAll('.btn-beli').forEach(tombol => {
                const itemId = tombol.getAttribute('data-item');
                const cost = parseInt(tombol.parentElement.getAttribute('data-cost'), 10);
                
                if (inventory[itemId]) {
                    tombol.textContent = 'Sudah Dibeli!';
                    tombol.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    tombol.classList.add('bg-green-500', 'text-white', 'cursor-default');
                    tombol.disabled = true;
                } else {
                    tombol.classList.remove('bg-green-500', 'text-white', 'cursor-default');
                    tombol.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                    tombol.disabled = totalBintang < cost;
                    
                    // Memastikan teks tombol kembali normal jika tombol tidak disable
                    if (!tombol.disabled) {
                       tombol.innerHTML = `${cost} <i class="ph-fill ph-star text-sm"></i>`;
                    } else {
                       tombol.innerHTML = `${cost} <i class="ph-fill ph-star text-sm"></i>`;
                    }
                }
            });
        }

        function applyAvatarStyle() {
            avatarBodyEl.textContent = 'üßë';
            avatarOverlayEl.textContent = '';
            avatarContainerEl.style.backgroundColor = '#fef08a';
            avatarContainerEl.style.borderColor = '#f97316';

            Object.keys(inventory).forEach(itemId => {
                const item = inventory[itemId];
                if (item.used) {
                    const shopItem = shopItems[itemId];
                    if (shopItem.type === 'aksesoris') {
                        avatarOverlayEl.textContent = shopItem.value;
                    } else if (shopItem.type === 'latar') {
                        avatarContainerEl.style.backgroundColor = shopItem.value;
                        avatarContainerEl.style.borderColor = shopItem.value === '#1e3a8a' ? '#fbbf24' : '#f97316';
                    }
                }
            });
        }

        function renderHadiahFisikList() {
            physicalRewardListEl.innerHTML = '';
            if (physicalRewards.length === 0) {
                physicalRewardListEl.innerHTML = '<p class="text-sm text-center text-gray-500 bg-white p-4 rounded-xl shadow-md">Belum ada hadiah fisik yang diatur oleh orang tua.</p>';
                return;
            }

            physicalRewards.forEach(reward => {
                const div = document.createElement('div');
                div.className = 'misi-card !items-stretch';
                div.innerHTML = `
                    <div class="ikon-misi bg-red-100 text-red-600">
                        <i class="ph-fill ph-gift"></i>
                    </div>
                    <div class="info-misi flex-grow">
                        <h3 class="font-semibold text-gray-800">${reward.name}</h3>
                        <p class="text-xs text-red-500">Hadiah Spesial Ortu</p>
                    </div>
                    <button class="btn-tukar-hadiah w-28 bg-red-500 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed" 
                            data-id="${reward.id}" data-cost="${reward.cost}" ${totalBintang < reward.cost || reward.used ? 'disabled' : ''}>
                        ${reward.used ? 'Sudah Ditukar' : `Tukar (${reward.cost} <i class="ph-fill ph-star text-sm"></i>)`}
                    </button>
                `;
                physicalRewardListEl.appendChild(div);
            });

            document.querySelectorAll('.btn-tukar-hadiah').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const rewardId = e.currentTarget.getAttribute('data-id');
                    const cost = parseInt(e.currentTarget.getAttribute('data-cost'), 10);
                    const reward = physicalRewards.find(r => r.id === rewardId);

                    if (totalBintang >= cost && !reward.used) {
                        if (window.confirm(`Yakin ingin menukar "${reward.name}" dengan ${cost} bintang? Ini akan mengurangi total bintang Anda.`)) {
                            totalBintang -= cost;
                            const rewardIndex = physicalRewards.findIndex(r => r.id === rewardId);
                            if (rewardIndex !== -1) {
                                physicalRewards[rewardIndex].used = true;
                            }
                            window.alert(`Selamat! Hadiah "${reward.name}" berhasil ditukar. Beri tahu orang tuamu!`);
                            updateTampilan();
                        }
                    }
                });
            });
        }
        
        function renderEditHadiahList() {
            editHadiahContainerEl.innerHTML = '';
            if (physicalRewards.length === 0) {
                editHadiahContainerEl.innerHTML = '<p class="text-sm text-center text-gray-500 p-2">Belum ada hadiah.</p>';
                return;
            }

            physicalRewards.forEach(reward => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-3 rounded-lg border';
                div.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-semibold text-gray-800">${reward.name}</span>
                        <span class="text-sm text-yellow-600 font-bold ml-2">(${reward.cost} <i class="ph-fill ph-star text-xs"></i>)</span>
                        ${reward.used ? '<span class="text-xs text-red-500 ml-2">(Ditukar)</span>' : ''}
                    </div>
                    <button class="btn-hapus-hadiah text-red-500 hover:text-red-700 p-1" data-id="${reward.id}">
                        <i class="ph-fill ph-trash"></i>
                    </button>
                `;
                editHadiahContainerEl.appendChild(div);
            });

            document.querySelectorAll('.btn-hapus-hadiah').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const rewardId = e.currentTarget.getAttribute('data-id');
                    if (window.confirm('Yakin ingin menghapus hadiah ini?')) {
                        physicalRewards = physicalRewards.filter(r => r.id !== rewardId);
                        updateTampilan();
                    }
                });
            });
        }
        
        function renderEditMisiList() {
            editMisiContainerEl.innerHTML = '';

            Object.values(currentMissions).forEach(misi => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-lg border flex flex-col space-y-2';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-lg text-gray-800">${misi.nama}</span>
                        <button class="btn-hapus-misi text-red-500 hover:text-red-700 p-1" data-id="${misi.id}">
                             <i class="ph-fill ph-trash text-xl"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex-grow">
                            <label class="text-sm font-semibold text-gray-700 block mb-1">Nama Misi:</label>
                            <input type="text" data-id="${misi.id}" data-field="nama" value="${misi.nama}" class="input-edit-misi w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        <div class="w-1/4">
                            <label class="text-sm font-semibold text-gray-700 block mb-1">Poin:</label>
                            <input type="number" data-id="${misi.id}" data-field="poin" value="${misi.poin}" min="1" class="input-edit-misi w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700 block mb-1">Keterangan Singkat:</label>
                        <input type="text" data-id="${misi.id}" data-field="keterangan" value="${misi.keterangan}" class="input-edit-misi w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                `;
                editMisiContainerEl.appendChild(div);
            });
            
            document.querySelectorAll('.btn-hapus-misi').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const misiId = e.currentTarget.getAttribute('data-id');
                    if (Object.keys(currentMissions).length > 1) {
                         if (window.confirm(`Yakin ingin menghapus misi "${currentMissions[misiId].nama}"?`)) {
                            delete currentMissions[misiId];
                            renderEditMisiList(); 
                         }
                    } else {
                        window.alert("Tidak bisa menghapus! Minimal harus ada satu misi harian.");
                    }
                });
            });
        }
        
        function simpanEditMisi() {
            const inputs = editMisiContainerEl.querySelectorAll('.input-edit-misi');
            let hasChanges = false;
            
            inputs.forEach(input => {
                const id = input.getAttribute('data-id');
                const field = input.getAttribute('data-field');
                let newValue;

                if (field === 'poin') {
                    newValue = parseInt(input.value, 10);
                    if (isNaN(newValue) || newValue < 1) {
                        console.error(`Poin untuk misi ${id} tidak valid.`);
                        return;
                    }
                } else {
                    newValue = input.value.trim();
                }
                
                if (currentMissions[id][field] != newValue) {
                    currentMissions[id][field] = newValue;
                    hasChanges = true;
                }
            });

            if (hasChanges) {
                window.alert("Perubahan misi harian telah disimpan. Anak akan melihat misi yang diperbarui.");
            }
            updateTampilan();
            hideModal(modalEditMisiEl);
        }

        function renderInventory() {
            inventoryListEl.innerHTML = '';
            const items = Object.keys(inventory).filter(id => inventory[id]);
            
            if (items.length === 0) {
                emptyInventoryMessageEl.classList.remove('hidden');
                return;
            }
            emptyInventoryMessageEl.classList.add('hidden');

            items.forEach(itemId => {
                const item = inventory[itemId];
                const button = document.createElement('button');
                button.className = `inventory-item flex flex-col items-center p-3 rounded-xl border-2 transition-all duration-300 ${item.used ? 'border-blue-500 bg-blue-50 shadow-lg' : 'border-gray-200 bg-white hover:border-blue-300'}`;
                button.setAttribute('data-id', itemId);
                button.innerHTML = `
                    <span class="text-3xl">${item.value}</span>
                    <span class="text-xs font-semibold mt-1 text-center">${item.nama}</span>
                    <span class="text-[10px] text-gray-500 mt-1">${item.type === 'aksesoris' ? 'Aksesori' : 'Latar'}</span>
                    ${item.used ? '<span class="text-xs text-blue-500 font-bold mt-1">Dipakai</span>' : '<span class="text-xs text-gray-400 mt-1">Ketuk untuk Pakai</span>'}
                `;
                inventoryListEl.appendChild(button);
            });
        }

        function showParentDashboard() {
            ortuPinLockEl.classList.add('hidden');
            ortuDashboardEl.classList.remove('hidden');
            isParentAuthenticated = true;
            updateTampilan(); 
        } 

        function lockParentDashboard() {
            ortuDashboardEl.classList.add('hidden');
            ortuPinLockEl.classList.remove('hidden');
            pinInputEl.value = '';
            pinMessageEl.textContent = '';
            isParentAuthenticated = false;
        }

        function changePage(pageId) {
            Object.values(pages).forEach(page => {
                page.classList.add('hidden');
            });
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                const icon = btn.querySelector('i');
                const fillClass = icon.classList.contains('ph-fill');
                if (fillClass) {
                    icon.classList.remove('ph-fill');
                    icon.classList.add('ph-light');
                }
            });

            pages[pageId].classList.remove('hidden');
            const activeBtn = document.querySelector(`.nav-bar button[data-page="${pageId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                const icon = activeBtn.querySelector('i');
                icon.classList.remove('ph-light');
                icon.classList.add('ph-fill');
            }

            progressContainerEl.style.display = pageId === 'misi' ? 'block' : 'none';
        }
        
        const handleMisiCardClick = (e) => {
            const card = e.currentTarget;
            const misiId = card.id;
            const mission = currentMissions[misiId];
            
            if (mission && mission.completed) {
                if (window.confirm(`Yakin ingin membatalkan penyelesaian misi "${mission.nama}"? Misi akan di-reset (bintang akan dikurangi).`)) {
                    mission.completed = false;
                    totalBintang -= mission.poin;
                    updateTampilan();
                    window.alert(`Misi "${mission.nama}" dibatalkan. Bintang dikurangi ${mission.poin}.`);
                }
                return; 
            }
            
            misiIdTerpilihEl.value = misiId;
            buktiMisiNamaEl.textContent = card.getAttribute('data-nama');
            
            inputBuktiFileEl.value = '';
            fileNameDisplayEl.textContent = 'Belum ada file dipilih';
            btnSubmitBuktiEl.disabled = true;
            fileErrorMessageEl.style.display = 'none';

            showModal(modalUnggahBuktiEl);
        };


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {

            const MAX_FILE_SIZE = 5 * 1024 * 1024; 

            inputBuktiFileEl.addEventListener('change', (e) => {
                const file = e.target.files[0];

                if (file) {
                    if (file.size > MAX_FILE_SIZE) { 
                        fileNameDisplayEl.textContent = file.name;
                        fileErrorMessageEl.style.display = 'block';
                        btnSubmitBuktiEl.disabled = true;
                        inputBuktiFileEl.value = '';
                    } else {
                        fileNameDisplayEl.textContent = file.name;
                        fileErrorMessageEl.style.display = 'none';
                        btnSubmitBuktiEl.disabled = false;
                    }
                } else {
                    fileNameDisplayEl.textContent = 'Belum ada file dipilih';
                    fileErrorMessageEl.style.display = 'none';
                    btnSubmitBuktiEl.disabled = true;
                }
            });

            formUnggahBuktiEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const misiId = misiIdTerpilihEl.value;
                const file = inputBuktiFileEl.files[0];

                if (!misiId || !file) {
                    window.alert('Harap pilih misi dan unggah bukti.');
                    return;
                }
                
                if (file.size > MAX_FILE_SIZE) {
                    window.alert('Kesalahan: Ukuran file melebihi batas (5MB).');
                    return;
                }
                
                const mission = currentMissions[misiId];
                if (mission && !mission.completed) {
                    mission.completed = true;
                    totalBintang += mission.poin;
                    
                    updateTampilan();
                }
                
                hideModal(modalUnggahBuktiEl);
                
                window.alert(`Bukti untuk misi "${mission.nama}" berhasil diunggah (Simulasi) dan misi selesai! Anda mendapat +${mission.poin} bintang.`);
            });

            tutupBuktiBtn.addEventListener('click', () => {
                hideModal(modalUnggahBuktiEl);
            });

            resetBtnEl.addEventListener('click', () => {
                if (window.confirm('Yakin ingin memulai hari baru dan mereset misi? Bintang Anda tidak akan direset, tetapi semua misi akan diulang.')) {
                    Object.keys(currentMissions).forEach(id => {
                        currentMissions[id].completed = false;
                    });
                    physicalRewards.forEach(reward => {
                        reward.used = false;
                    });
                    updateTampilan();
                    window.alert('Misi harian telah direset. Selamat memulai hari baru!');
                }
            });

            document.querySelectorAll('.btn-beli').forEach(tombol => {
                tombol.addEventListener('click', (e) => {
                    const itemId = e.target.getAttribute('data-item');
                    const itemCard = document.getElementById(itemId);
                    const cost = parseInt(itemCard.getAttribute('data-cost'), 10);
                    
                    if (inventory[itemId]) {
                        window.alert('Item ini sudah Anda miliki.');
                        return;
                    }

                    if (totalBintang >= cost) {
                        if(window.confirm(`Yakin ingin membeli ${shopItems[itemId].nama} dengan ${cost} bintang?`)) {
                            totalBintang -= cost;
                            inventory[itemId] = { ...shopItems[itemId], used: true };
                            
                            Object.keys(inventory).forEach(id => {
                                if (id !== itemId && shopItems[id].type === shopItems[itemId].type) {
                                    inventory[id].used = false;
                                }
                            });
                            
                            e.target.textContent = 'Sudah Dibeli!';
                            e.target.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                            e.target.classList.add('bg-green-500', 'text-white', 'cursor-default');

                            window.alert(`Selamat! Anda membeli ${shopItems[itemId].nama}. Poin berkurang ${cost}. Item langsung dipakai.`);
                            updateTampilan();
                        }
                    } else {
                        window.alert('Bintang Anda tidak cukup! Kumpulkan lebih banyak lagi.');
                    }
                });
            });

            inventoryListEl.addEventListener('click', (e) => {
                const btn = e.target.closest('.inventory-item');
                if (btn) {
                    const itemId = btn.getAttribute('data-id');
                    const item = inventory[itemId];

                    Object.keys(inventory).forEach(id => {
                        if (shopItems[id].type === item.type) {
                            inventory[id].used = false; 
                        }
                    });
                    inventory[itemId].used = true; 

                    updateTampilan();
                    window.alert(`${item.nama} sekarang sedang dipakai!`);
                }
            });

            btnEditNamaEl.addEventListener('click', () => {
                inputNamaBaruEl.value = namaAnak;
                showModal(modalEditNamaEl);
            });
            tutupNamaBtn.addEventListener('click', () => {
                hideModal(modalEditNamaEl);
            });
            simpanNamaBtn.addEventListener('click', () => {
                const newName = inputNamaBaruEl.value.trim();
                if (newName) {
                    namaAnak = newName;
                    updateTampilan();
                    hideModal(modalEditNamaEl);
                } else {
                    window.alert('Nama tidak boleh kosong.');
                }
            });

            pinFormEl.addEventListener('submit', (e) => {
                e.preventDefault();
                if (pinInputEl.value === parentPin) {
                    pinMessageEl.textContent = 'PIN Benar! Selamat datang.';
                    pinMessageEl.classList.remove('text-red-500');
                    pinMessageEl.classList.add('text-green-500');
                    
                    setTimeout(showParentDashboard, 500);
                } else {
                    pinMessageEl.textContent = 'PIN Salah! Coba lagi.';
                    pinMessageEl.classList.remove('text-green-500');
                    pinMessageEl.classList.add('text-red-500');
                    pinInputEl.value = '';
                }
            });

            logoutButtonEl.addEventListener('click', () => {
                lockParentDashboard();
                changePage('misi'); 
            });
            
            aturHadiahBtn.addEventListener('click', () => {
                if(isParentAuthenticated) {
                    renderEditHadiahList();
                    showModal(modalHadiahFisikEl);
                } else {
                     window.alert("Anda harus masuk sebagai Orang Tua terlebih dahulu.");
                }
            });
            tutupHadiahBtn.addEventListener('click', () => {
                hideModal(modalHadiahFisikEl);
                updateTampilan(); 
            });
            formTambahHadiahEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const nama = inputHadiahNamaEl.value.trim();
                const poin = parseInt(inputHadiahPoinEl.value, 10);

                if (nama && poin >= 10) {
                    const newId = 'reward-' + Date.now();
                    physicalRewards.push({ id: newId, name: nama, cost: poin, used: false });
                    inputHadiahNamaEl.value = '';
                    inputHadiahPoinEl.value = '';
                    renderEditHadiahList();
                    updateTampilan();
                } else {
                    window.alert('Nama hadiah harus diisi dan Poin minimal 10.');
                }
            });

            editMisiBtn.addEventListener('click', () => {
                if(isParentAuthenticated) {
                    renderEditMisiList(); 
                    showModal(modalEditMisiEl);
                } else {
                     window.alert("Anda harus masuk sebagai Orang Tua terlebih dahulu.");
                }
            });
            
            tutupMisiBtn.addEventListener('click', () => {
                simpanEditMisi(); 
            });
            
            formTambahMisiEl.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nama = inputMisiNamaEl.value.trim();
                const keterangan = inputMisiKeteranganEl.value.trim();
                const poin = parseInt(inputMisiPoinEl.value, 10);

                if (nama && keterangan && poin >= 1) {
                    const newId = 'misi-' + Date.now();
                    
                    currentMissions[newId] = {
                        id: newId,
                        nama: nama,
                        keterangan: keterangan,
                        poin: poin,
                        completed: false,
                        ikonClass: 'ph-fill ph-lightbulb', 
                        ikonBg: 'bg-yellow-200 text-yellow-700'
                    };
                    
                    inputMisiNamaEl.value = '';
                    inputMisiKeteranganEl.value = '';
                    inputMisiPoinEl.value = '';
                    
                    renderEditMisiList(); 
                    updateTampilan();
                    
                    window.alert(`Misi baru ("${nama}") berhasil ditambahkan!`);
                } else {
                    window.alert('Semua kolom harus diisi dan Poin minimal harus 1.');
                }
            });


            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.getAttribute('data-page');
                    changePage(pageId);
                });
            });

            changePage('misi'); 
            updateTampilan();
            
            document.querySelectorAll('.btn-beli').forEach(tombol => {
                const itemId = tombol.getAttribute('data-item');
                if (inventory[itemId]) {
                    tombol.textContent = 'Sudah Dibeli!';
                    tombol.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    tombol.classList.add('bg-green-500', 'text-white', 'cursor-default');
                }
            });
        });
    </script>
</body>
</html>
